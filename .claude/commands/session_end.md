# WIM-Z Session End Command

## Safe Shutdown Protocol

### PHASE 0: Save Chat History & Update Structure
**Update Resume Chat Log:**
- Save last 1000 lines of conversation to `.claude/resume_chat.md`
- Include:
  - Problems solved this session
  - Key code changes made
  - Any unresolved issues or warnings
  - Next steps identified
- Format as markdown with timestamps
- Keep most recent entries at top

**Update Project Structure:**
- Review `.claude/WIM-Z_Project_Directory_Structure.md`
- Add any new files created this session
- Mark deprecated files for cleanup
- Note any structural issues found

### PHASE 1: Inventory (Show Only, Don't Execute)

#### New Files Created This Session
List all files created with timestamps:
```bash
# Files created in last session (since session start)
find . -type f -newer /tmp/session_start_marker -not -path './.git/*'
```

Group by directory (per Flutter app structure):
- `lib/core/` - Shared infrastructure (networking, constants, config)
- `lib/data/` - Models (Freezed classes) and API clients
- `lib/domain/` - Riverpod providers (state management)
- `lib/presentation/screens/` - Screen widgets
- `lib/presentation/widgets/` - Reusable UI components
- `lib/presentation/theme/` - Theme and styling
- `test/` - Test files (unit, widget, integration)
- `assets/` - Images, icons, animations, fonts
- `.claude/` - Session management and documentation
- **ROOT or other** - âš ï¸ Files in wrong location!
- **Generated** - `*.g.dart`, `*.freezed.dart` (should be gitignored)

#### Modified Files
```bash
git status --short
git diff --stat
```

Show:
- Lines added/removed per file
- Which functions/classes changed
- Any TODO comments added

#### Files Outside Proper Structure
Check for violations of project structure:
- Dart files in root â†’ Should be in `lib/`
- Test files outside `test/` â†’ Should be in `test/`
- Generated files committed â†’ Should be in `.gitignore`
- Screens not in `lib/presentation/screens/`
- Widgets not in `lib/presentation/widgets/`

---

### PHASE 2: Verification

#### Protected Files Integrity Check
Verify these files are unchanged:
```bash
git diff HEAD -- notes.txt
git diff HEAD -- docs/
git diff HEAD -- pubspec.yaml  # Review if dependencies changed
```

If modified without permission:
```
âš ï¸  WARNING: Protected file modified!
File: notes.txt
Status: Modified (12 lines changed)

This file should NOT be modified. 
Options:
1. Revert changes (git checkout -- notes.txt)
2. Review changes first (show diff)
3. Keep changes (explain why)

What should I do?
```

#### Test File Location Check
List any test files NOT in `test/`:
```
âš ï¸  Files in wrong location:
- ./lib/test_widget.dart â†’ Should be ./test/widget_test.dart
- ./connection_test.dart â†’ Should be ./test/connection_test.dart

Move these files? (yes/no)
```

---

### PHASE 3: Commit Planning

#### If Uncommitted Changes Exist

**Option A: Stage All Changes**
```bash
git add -A
git status
```

Show proposed commit message:
```
Proposed commit message:

feat: Add real-time telemetry display

Changes:
- Created lib/presentation/widgets/status/telemetry_card.dart
- Added telemetryProvider in lib/domain/providers/
- Integrated WebSocket updates for live data
- Added widget tests in test/widgets/telemetry_card_test.dart

Files changed: 4
Lines added: 287
Lines removed: 12

Approve this commit? (yes/no/edit)
```

**Option B: Selective Staging**
```
Which files should be committed?

[ ] lib/presentation/widgets/status/telemetry_card.dart (new widget)
[ ] lib/domain/providers/telemetry_provider.dart (new provider)
[ ] test/widgets/telemetry_card_test.dart (tests)
[x] notes.txt (skip - user notes)
[x] *.g.dart, *.freezed.dart (skip - generated files)

Or:
- 'all' to stage everything
- 'none' to skip commit
- 'review' to see diffs
```

#### If No Changes
```
âœ… No uncommitted changes
Last commit: feat: Add camera tracking (2 hours ago)
```

---

### PHASE 4: Documentation Update

**Check if major functionality changed:**
- New screens created?
- New providers added?
- API client methods added?
- Navigation routes changed?

If yes, ask:
```
Should I update documentation?

Changed components:
- lib/presentation/screens/telemetry/ (new screen)
- lib/domain/providers/telemetry_provider.dart (new provider)
- README.md could mention telemetry feature

Options:
1. Update README.md (add feature description)
2. Update .claude/CLAUDE.md (add architecture notes)
3. Update .claude/WIM-Z_Project_Directory_Structure.md (add new files)
4. Skip for now (manual update later)

What should I update? (1/2/3/4/all/none)
```

---

### PHASE 5: Cleanup Recommendations

#### Suggest Cleanup Actions (Don't Execute)
```
ğŸ“‹ Cleanup Recommendations:

1. Generated files not in .gitignore:
   - lib/**/*.g.dart (generated by build_runner)
   - lib/**/*.freezed.dart (generated by Freezed)
   â†’ Add to .gitignore? (yes/no)

2. Unused imports or dead code:
   - Run `dart analyze` for warnings
   â†’ Fix analyzer warnings? (yes/no)

3. Build artifacts:
   - build/ directory (can be large)
   â†’ Clean with `flutter clean`? (yes/no)

4. Scattered test files (not in test/):
   - None found âœ…

5. Update directory structure knowledge:
   - `.claude/WIM-Z_Project_Directory_Structure.md`

Execute cleanup? (yes/no/review)
```

---

### PHASE 6: Session Summary

#### Show Work Completed
```
ğŸ“Š Session Summary
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Goal: Implement real-time telemetry display
Duration: 2 hours 15 minutes

âœ… Completed:
  - Created TelemetryCard widget (lib/presentation/widgets/status/)
  - Added telemetryProvider with WebSocket integration
  - Integrated with home screen dashboard
  - Wrote widget tests (all passing)

ğŸ“ Files Modified:
  - 3 new files
  - 2 existing files modified
  - 287 lines added, 12 removed

ğŸ”¬ Tests:
  - `flutter test` - 8/8 passing âœ…
  - `dart analyze` - No issues

ğŸ“¦ Git Status:
  - Ready to commit: 4 files
  - Generated files: Excluded âœ…
  - Protected files: Unchanged âœ…

ğŸš§ Next Steps:
  1. Test on physical device with WIM-Z connection
  2. Add error states for connection loss
  3. Polish animations and transitions

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Everything look good? (yes/no)
```

---

### PHASE 7: Final Actions

#### Commit Changes (If Approved)
```bash
git commit -m "feat: Add camera servo tracking system"
git log --oneline -1  # Show commit
```

#### Update Session Log
Update `.claude/resume_chat.md` with session summary:
```markdown
## Session: 2026-01-18 15:30
**Goal:** Real-time telemetry display
**Status:** âœ… Complete

### Work Completed:
- Created lib/presentation/widgets/status/telemetry_card.dart
- Added lib/domain/providers/telemetry_provider.dart
- Integrated WebSocket for live updates
- Added test/widgets/telemetry_card_test.dart

### Key Solutions:
- Used StreamProvider for reactive WebSocket updates
- Implemented auto-reconnect with exponential backoff
- Added loading/error states for better UX

### Files Modified:
- lib/presentation/widgets/status/telemetry_card.dart (new)
- lib/domain/providers/telemetry_provider.dart (new)
- lib/presentation/screens/home/home_screen.dart (modified)
- test/widgets/telemetry_card_test.dart (new)

### Commit: a1b2c3d - feat: Add real-time telemetry display

### Next Session:
- Test on physical device with WIM-Z
- Add connection error handling UI
- Polish animations

### Important Notes/Warnings:
- Remember to run `dart run build_runner build` after provider changes
```

Optionally append brief note to `notes.txt` if user wants personal tracking

#### Final Checklist
```
âœ… All changes committed (or intentionally skipped)
âœ… Protected files unchanged
âœ… No files in wrong locations
âœ… Documentation updated (or deferred)
âœ… Session logged

Safe to close Claude Code. Goodbye! ğŸ‘‹
```

---

## Usage
Call this command at the end of every Claude Code session:
```bash
/project:session-end
```

Or in VS Code extension: Type `/session-end` in chat

---

## CRITICAL RULES
- NEVER commit without showing user what will be committed
- NEVER delete files without explicit approval
- NEVER skip verification of protected files
- ALWAYS show session summary before closing
- ALWAYS offer to update documentation if needed

## Emergency Recovery
If something went wrong this session:
```bash
# See what changed
git diff HEAD

# Undo all changes
git checkout HEAD -- .

# Or undo specific file
git checkout HEAD -- path/to/file.py
```